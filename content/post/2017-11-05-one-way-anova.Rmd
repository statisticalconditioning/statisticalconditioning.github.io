---
title: 'One Way ANOVA '
author: William Murrah
date: '2017-11-05'
publishdate: '2017-11-07'
slug: one-way-anova
categories: []
tags: ["ERMA7300"]
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, comment = NULL, warning = FALSE, message = FALSE)
library(pander)
library(tidyverse, warn.conflicts = FALSE)
library(xtable)
library(ztable)
library(mosaic)

options(ztable.type = "html")
options(scipen=1, digits=2)
```

```{r, functions, echo = FALSE}
# Munge ANOVA data
mng_aov <- function(x){
  m <- matrix(x, nrow = 15, byrow = T)
  score <- m[ ,1]
  group <- m[ ,2]
  d <- data.frame(group = factor(group, labels = c('A', 'B', 'C')),
                  score)
  return(d)
}
```

## New Notation

Symbol     | Description
-----------|-------------
$k$        | number of groups
$n$        | number in each group
$N$        | total number of participants ($N = n \times k$)
$df_{B}$  | between group degrees of freedom
$df_E$ or $df_{W}$   | error or within-group degrees of freedom
$SS_{B}$  | sum of squares between group
$SS_W$     | sum of squares error
$SS_T$     | sum of squares total
$MS_{B}$  | mean square between group
$MS_W$     | mean square error

## Formulae

### Degrees of freedom

$$
df_{B} = k - 1,
$$

$$
df_{BP} = n - 1.
$$
$$
df_W = (k - 1)(n - 1)
$$

$$
df_T = N - 1 = df_{B} + df_W
$$

### $F$ statistic

$$
F_{obt} = \frac{\text{variance between groups}}{{\text{variance within groups}}} = \frac{MS_{B}}{MS_W}
$$


### Statistical hypotheses

#### Null
$$
H_0: \sigma^2_{\mu} = 0.
$$

#### Alternative
$$
H_a: \sigma^2_\mu > 0.
$$
\newpage

## Example 1: Substantial Between Subjects Variance, with Negligible Within Group Variance

```{r, echo=FALSE, results='asis'}
x <- c(0.9, 1, 0.9, 1, 1, 1, 1.1, 1, 1.1, 1, 1.9, 2, 1.9, 2, 2, 2, 
  2.1, 2, 2.1, 2, 2.9, 3, 2.9, 3, 3, 3, 3.1, 3, 3.1, 3)
d <- mng_aov(x)
d <- mutate(d, score2 = score^2)
z <- ztable(d, align = "cccc")
z <- addrgroup(z, 
               rgroup = c('Group A', 'Group B', 'Group C'),
               n.rgroup = c(5, 5, 5), cspan.rgroup = 1)
z
```

```{r, echo=FALSE}
ggplot(d, aes(score)) +
      facet_wrap(~ group, ncol = 1) +
      geom_bar()
```

```{r, echo=FALSE}
bx <- ggplot(d, aes(group, score)) + 
      geom_boxplot()
bx

```

### Stage 1: Preliminary Calculations

```{r, echo=FALSE, results='asis'}
t <- d %>% 
  group_by(group) %>%
  summarise(n = n(),
            mean = mean(score),
            sd = sd(score),
            var = var(score),
            sum.x = sum(score),
            sum.x2 = sum(score^2)
            )
y <- d %>%
  summarise(n = n(),
            mean = mean(score),
            sd = sd(score),
            var = var(score),
            sum.x = sum(score),
            sum.x2 = sum(score^2)
            )

  
N <- sum(t$n)
k = 3
df_B <- k - 1
df_W <- N - k
df <- N - 1
sum.xT <- sum(t$sum.x)
sum.x2T <- sum(t$sum.x2)
sum.xT_2 <- sum(sum.xT)^2
cf <- sum.xT_2/N
sum.x2_n <- sum(t$sum.x^2/t$n)

SS_B <- sum.x2_n - cf
SS_T <- sum.x2T - cf
SS_W <- SS_T - SS_B

MS_B <- SS_B/df_B
MS_W <- SS_W/df_W
F_obt <- MS_B/MS_W

yd <- data.frame(group = NA , y)
z <- ztable(rbind(as.data.frame(t), yd))
z <- hlines(z, add = 3)
z$x$group <- addNA(z$x$group)
levels(z$x$group) <- c('A', 'B', 'C', 'Total')
z
```

$N = n \times k =$ `r N`

$df_{B} = k -1 =$ `r k -1`

$df_W = N - k =$ `r N - k`

$df = N - 1=$ `r N - 1`

$\Sigma{x_T} =$ `r sum.xT`

$\Sigma{x^2_T} =$ `r sum.x2T`

$(\Sigma{x_T})^2 =$ `r sum.xT_2` 

$\Sigma{\frac{x^2}{n}}=$ `r sum.x2_n`

### State 2: Intermediate Calculations

#### Correction factor 

$[1]\text{correction factor} = \frac{(\Sigma{x_T})^2}{N}= \frac{900}{15}=$ `r sum.xT_2/N` 

#### Average sum of squares 

$[2]\Sigma{\frac{x^2}{n}}=$ `r sum.x2_n`

#### Restate the sum of squared scores

$[3]\Sigma{x^2_T}=$ `r sum.x2T`

### Stage 3: Calculating Sum of Squares (SS)

#### Sum of Squares between group

$SS_{B} = [2] - [1]= `r sum.x2_n` - `r cf` =$ `r SS_B`

$SS_T = [3] - [1] =$ `r sum.x2T` - `r cf` = `r SS_T`

$SS_W = SS_T - SS_{B} =$ `r SS_T` - `r SS_B` = `r SS_T - SS_B`

### Stage 4: Completing the *F* table

#### Mean square between groups

$MS_{B} = \frac{SS_{B}}{df_{B}} = \frac{`r SS_B`}{`r df_B`}=$ `r MS_B`

$MS_W = \frac{SS_W}{df_W} = \frac{`r SS_W`}{`r df_W`}=$ `r MS_W`

$F_{obt} = \frac{MS_{B}}{MS_W}=\frac{`r MS_B`}{`r MS_W`} =$ `r F_obt`

```{r, echo=FALSE, results='asis'}
res <- aov(score ~ group, d)
ztable(anova(res))
```

\newpage

## Example 2: Negligible Between Subject Variance, with Substantial Within Group Variance

```{r, results='asis'}
x <- c(0, 1, 0, 1, 1, 1, 2, 1, 2, 1, 0.1, 2, 0.1, 2, 1.1, 2, 2.1, 2, 2.1, 2, 0.2, 3, 0.2, 3, 1.2, 3, 2.2, 3, 2.2, 3)
d <- mng_aov(x)
d <- mutate(d, score2 = score^2)
z <- ztable(d, align = "cccc")
z <- addrgroup(z,
               rgroup = c('Group A', 'Group B', 'Group C'),
               n.rgroup = c(5, 5, 5), cspan.rgroup = 1)
z
```

```{r, echo=FALSE}
ggplot(d, aes(score)) +
      facet_wrap(~ group, ncol = 1) +
      geom_bar(width = .9)
```

```{r, echo=FALSE}
bx <- ggplot(d, aes(group, score)) + 
      geom_boxplot()
bx

```

### Stage 1: Preliminary Calculations

```{r, echo=FALSE, results='asis'}
t <- d %>% 
  group_by(group) %>%
  summarise(n = n(),
    mean = mean(score),
            sd = sd(score),
            var = var(score),
            sum.x = sum(score),
            sum.x2 = sum(score^2)
            )
y <- d %>%
  summarise(n = n(),
            mean = mean(score),
            sd = sd(score),
            var = var(score),
            sum.x = sum(score),
            sum.x2 = sum(score^2)
            )

N <- sum(t$n)
k = 3
df_B <- k - 1
df_W <- N - k
df <- N - 1
sum.xT <- sum(t$sum.x)
sum.x2T <- sum(t$sum.x2)
sum.xT_2 <- sum(sum.xT)^2
cf <- sum.xT_2/N
sum.x2_n <- sum(t$sum.x^2/t$n)

SS_B <- sum.x2_n - cf
SS_T <- sum.x2T - cf
SS_W <- SS_T - SS_B

MS_B <- SS_B/df_B
MS_W <- SS_W/df_W
F_obt <- MS_B/MS_W

yd <- data.frame(group = NA , y)
z <- ztable(rbind(as.data.frame(t), yd))
z <- hlines(z, add = 3)
z$x$group <- addNA(z$x$group)
levels(z$x$group) <- c('A', 'B', 'C', 'Total')
z
```

$N=$ `r N`

$df_{B} = k -1 =$ `r k -1`

$df_W = N - k =$ `r N - k`

$df = N - 1=$ `r N - 1`

$\Sigma{x_T} =$ `r sum.xT`

$\Sigma{x^2_T} =$ `r sum.x2T`

$(\Sigma{x_T})^2 =$ `r sum.xT_2` 

$\Sigma{\frac{x^2}{n}}=$ `r sum.x2_n`

### State 2: Intermediate Calculations

#### Correction factor

$[1]\text{correction factor} = \frac{(\Sigma{x_T})^2}{N}= \frac{900}{15}=$ `r sum.xT_2/N` 

#### Average sum of squares 

$[2]\Sigma{\frac{x^2}{n}}=$ `r sum.x2_n`

#### Restate the sum of squared scores

$[3]\Sigma{x^2_T}=$ `r sum.x2T`

### Stage 3: Calculating Sum of Squares (SS)

#### Sum of Squares between group

$SS_{B} = [2] - [1]= `r sum.x2_n` - `r cf` =$ `r SS_B`

$SS_T = [3] - [1] =$ `r sum.x2T` - `r cf` = `r SS_T`

$SS_W = SS_T - SS_{B} =$ `r SS_T` - `r SS_B` = `r SS_T - SS_B`

### Stage 4: Completing the *F* table

#### Mean square between groups

$MS_{B} = \frac{SS_{B}}{df_{B}} = \frac{`r SS_B`}{`r df_B`}=$ `r MS_B`

$MS_W = \frac{SS_W}{df_W} = \frac{`r SS_W`}{`r df_W`}=$ `r MS_W`

$F_{obt} = \frac{MS_{B}}{MS_W}=\frac{`r MS_B`}{`r MS_W`} =$ `r F_obt`

```{r, echo=FALSE, results='asis'}
res <- aov(score ~ group, d)
ztable(anova(res))
```

\newpage

## Example 3: Post-Hoc Comparisons


```{r, echo=FALSE, results='asis'}
x = c(0.9, 1, 0.9, 1, 1, 1, 1.1, 1, 1.1, 1, 0.9, 2, 0.9, 2, 1, 2, 
1.1, 2, 1.1, 2, 1.9, 3, 1.9, 3, 2, 3, 2.1, 3, 2.1, 3)
d <- mng_aov(x)
d <- mutate(d, score2 = score^2)
z <- ztable(d, align = "cccc")
z <- addrgroup(z, 
               rgroup = c('Group A', 'Group B', 'Group C'),
               n.rgroup = c(5, 5, 5), cspan.rgroup = 1)
z
```

```{r, echo=FALSE}
ggplot(d, aes(score)) +
      facet_wrap(~ group, ncol = 1) +
      geom_bar()
```

```{r, echo=FALSE}
bx <- ggplot(d, aes(group, score)) + 
      geom_boxplot()
bx

```

### Stage 1: Preliminary Calculations

```{r, echo=FALSE, results='asis'}
t <- d %>% 
  group_by(group) %>%
  summarise(n = n(),
    mean = mean(score),
            sd = sd(score),
            var = var(score),
            sum.x = sum(score),
            sum.x2 = sum(score^2)
            )
y <- d %>%
  summarise(n = n(),
            mean = mean(score),
            sd = sd(score),
            var = var(score),
            sum.x = sum(score),
            sum.x2 = sum(score^2)
            )

N <- sum(t$n)
n <- N/k
k = 3
df_B <- k - 1
df_W <- N - k
df <- N - 1
sum.xT <- sum(t$sum.x)
sum.x2T <- sum(t$sum.x2)
sum.xT_2 <- sum(sum.xT)^2
cf <- sum.xT_2/N
sum.x2_n <- sum(t$sum.x^2/t$n)

SS_B <- sum.x2_n - cf
SS_T <- sum.x2T - cf
SS_W <- SS_T - SS_B

MS_B <- SS_B/df_B
MS_W <- SS_W/df_W
F_obt <- MS_B/MS_W

yd <- data.frame(group = NA , y)
z <- ztable(rbind(as.data.frame(t), yd))
z <- hlines(z, add = 3)
z$x$group <- addNA(z$x$group)
levels(z$x$group) <- c('A', 'B', 'C', 'Total')
z
```

$N = n \times k =$ `r N`

$df_{B} = k -1 =$ `r k -1`

$df_W = N - k =$ `r N - k`

$df = N - 1=$ `r N - 1`

$\Sigma{x_T} =$ `r sum.xT`

$\Sigma{x^2_T} =$ `r sum.x2T`

$(\Sigma{x_T})^2 =$ `r sum.xT_2` 

$\Sigma{\frac{x^2}{n}}=$ `r sum.x2_n`

### State 2: Intermediate Calculations

#### Correction factor

$[1]\text{correction factor} = \frac{(\Sigma{x_T})^2}{N}= \frac{900}{15}=$ `r sum.xT_2/N` 

#### Average sum of squares 

$[2]\Sigma{\frac{x^2}{n}}=$ `r sum.x2_n`

#### Restate the sum of squared scores

$[3]\Sigma{x^2_T}=$ `r sum.x2T`

### Stage 3: Calculating Sum of Squares (SS)

#### Sum of Squares between group

$SS_{B} = [2] - [1]= `r sum.x2_n` - `r cf` =$ `r SS_B`

$SS_T = [3] - [1] =$ `r sum.x2T` - `r cf` = `r SS_T`

$SS_W = SS_T - SS_{B} =$ `r SS_T` - `r SS_B` = `r SS_T - SS_B`

### Stage 4: Completing the *F* table

#### Mean square between groups

$MS_{B} = \frac{SS_{B}}{df_{B}} = \frac{`r SS_B`}{`r df_B`}=$ `r MS_B`

$MS_W = \frac{SS_W}{df_W} = \frac{`r SS_W`}{`r df_W`}=$ `r MS_W`

$F_{obt} = \frac{MS_{B}}{MS_W}=\frac{`r MS_B`}{`r MS_W`} =$ `r F_obt`

```{r, echo=FALSE, results='asis'}
res <- aov(score ~ group, d)
ztable(anova(res))
```

## Pairwise Comparisons

It is important to control the **experimentwise alpha** so that the probabilty of rejecting the null, assuming the null is true is equal to or less than the pre-established alpha level (e.g. $\alpha = .05$).

### Fisher's Least Significant Difference (LSD) Test

Fisher's LSD is the most liberal post-hoc test generally accepted in published research.


$$
\text{Fisher's LSD}:  t_\alpha \sqrt{MS_W \bigg( \frac{1}{n_1} + \frac{1}{n_2}\bigg)},
$$
where $t_\alpha$ is the critical value for a two-tailed *t* test at $\alpha = .05$.

For our example 3 data, we calculate Fisher's LSD as follows:

```{r, echo=FALSE}
t_a <- round(qt(.95, df = df_W),2)
```

$$
\text{Fisher's LSD} =`r t_a` \sqrt{`r MS_W` \bigg(\frac{1}{`r n`} + \frac{1}{`r n`}\bigg)} = `r t_a*(sqrt(MS_W*((1/n) + (1/n))))` ,
$$
where $t_\alpha =$ `r t_a` is the *t* value with degrees of freedom (df = `r df_W`) from the error degrees of freedom found in the *F* table above.

### Tukey's Honestly Significant Difference (HSD) Test

Tukey's HSD is more conservative than Fisher's LSD.

$$
\text{Tukey's HSD}: q_\alpha \sqrt{\frac{MS_W}{n}},
$$
where $q_\alpha$ is the **studentized range statistics** which can be found using table B.4 in the appendix of the textbook.

For our example 3 data, Tukey's HSD is calculated as

```{r, echo=FALSE}
q_a <- round(qtukey(.95, 3, df_W),2)
```


$$
\text{Tukey's HSD} = `r q_a` \sqrt{\frac{`r MS_W`}{`r n`}} = `r  q_a*(sqrt(MS_W/n))`,
$$